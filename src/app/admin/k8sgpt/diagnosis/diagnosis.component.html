<div class="clr-row">
  <div class="clr-col-lg-12 clr-col-md-12 clr-col-sm-12 clr-col-xs-12">
    <div class="clr-row flex-items-xs-between flex-items-xs-top" style="padding-left: 15px; padding-right: 15px;">
      <h2 class="header-title">K8sGPT 集群诊断</h2>
    </div>

    <div class="card" style="margin: 15px;">
      <div class="card-header">
        诊断配置
      </div>
      <div class="card-block">
        <form clrForm clrLayout="horizontal" #diagnosisForm="ngForm">
          <clr-select-container>
            <label class="required">选择集群</label>
            <select clrSelect [(ngModel)]="selectedCluster" name="cluster" required>
              <option value="">请选择集群</option>
              <option *ngFor="let cluster of clusters" [value]="cluster.name">{{cluster.name}}</option>
            </select>
            <clr-control-error>请选择集群</clr-control-error>
          </clr-select-container>

          <clr-input-container>
            <label>命名空间</label>
            <input type="text" clrInput [(ngModel)]="selectedNamespace" name="namespace"
              placeholder="留空则分析所有命名空间">
          </clr-input-container>

          <clr-select-container>
            <label>AI后端</label>
            <select clrSelect [(ngModel)]="selectedBackend" name="backend">
              <option [ngValue]="undefined">使用默认后端</option>
              <option *ngFor="let backend of backends" [ngValue]="backend.id">
                {{backend.name}} ({{backend.provider}})
              </option>
            </select>
          </clr-select-container>

          <div class="clr-form-control clr-row">
            <label class="clr-control-label">分析器过滤器</label>
            <div class="clr-control-container clr-col-md-10 clr-col-12">
              <div class="card" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
                <div class="card-block" style="padding: 15px;">
                  <div *ngIf="analyzers.core.length === 0 && analyzers.additional.length === 0 && analyzers.integration.length === 0" 
                       class="alert alert-info">
                    <div class="alert-item">
                      <span class="alert-text">正在加载分析器列表...</span>
                    </div>
                  </div>

                  <div *ngIf="analyzers.core.length > 0">
                    <h6 style="margin-bottom: 10px; font-weight: bold;">核心分析器 ({{analyzers.core.length}})</h6>
                    <clr-checkbox-wrapper *ngFor="let analyzer of analyzers.core; let i = index">
                      <input type="checkbox" clrCheckbox 
                        [id]="'core-' + i"
                        [checked]="filterStates[analyzer]"
                        (change)="onFilterChange(analyzer, $event)">
                      <label [for]="'core-' + i">{{analyzer}}</label>
                    </clr-checkbox-wrapper>
                  </div>

                  <div *ngIf="analyzers.additional.length > 0" style="margin-top: 20px;">
                    <h6 style="margin-bottom: 10px; font-weight: bold;">附加分析器 ({{analyzers.additional.length}})</h6>
                    <clr-checkbox-wrapper *ngFor="let analyzer of analyzers.additional; let i = index">
                      <input type="checkbox" clrCheckbox 
                        [id]="'additional-' + i"
                        [checked]="filterStates[analyzer]"
                        (change)="onFilterChange(analyzer, $event)">
                      <label [for]="'additional-' + i">{{analyzer}}</label>
                    </clr-checkbox-wrapper>
                  </div>

                  <div *ngIf="analyzers.integration.length > 0" style="margin-top: 20px;">
                    <h6 style="margin-bottom: 10px; font-weight: bold;">集成分析器 ({{analyzers.integration.length}})</h6>
                    <clr-checkbox-wrapper *ngFor="let analyzer of analyzers.integration; let i = index">
                      <input type="checkbox" clrCheckbox 
                        [id]="'integration-' + i"
                        [checked]="filterStates[analyzer]"
                        (change)="onFilterChange(analyzer, $event)">
                      <label [for]="'integration-' + i">{{analyzer}}</label>
                    </clr-checkbox-wrapper>
                  </div>

                  <p class="text-muted" style="margin-top: 15px; font-size: 12px;">
                    <small>不选择任何分析器将使用所有可用的分析器</small>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="clr-form-control clr-row">
            <div class="clr-control-container clr-col-md-10 clr-col-12">
              <button type="button" class="btn btn-primary" [disabled]="!selectedCluster || isAnalyzing"
                (click)="analyze()">
                <clr-icon shape="play" *ngIf="!isAnalyzing"></clr-icon>
                <span class="spinner spinner-inline" *ngIf="isAnalyzing"></span>
                {{isAnalyzing ? '诊断中...' : '开始诊断'}}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card" style="margin: 15px;" *ngIf="showResults">
      <div class="card-header">
        诊断结果 ({{results.length}} 个问题)
      </div>
      <div class="card-block">
        <div *ngIf="results.length === 0" class="alert alert-success">
          <div class="alert-item">
            <span class="alert-text">未发现任何问题！</span>
          </div>
        </div>

        <div *ngIf="results.length > 0">
          <clr-datagrid>
            <clr-dg-column>资源类型</clr-dg-column>
            <clr-dg-column>资源名称</clr-dg-column>
            <clr-dg-column>问题描述</clr-dg-column>
            <clr-dg-column>父对象</clr-dg-column>

            <clr-dg-row *clrDgItems="let result of results" [clrDgItem]="result">
              <clr-dg-cell>
                <span class="badge">{{result.kind}}</span>
              </clr-dg-cell>
              <clr-dg-cell>{{result.name}}</clr-dg-cell>
              <clr-dg-cell>
                <div class="problem-description" [title]="getErrorText(result)">
                  {{getErrorText(result)}}
                </div>
              </clr-dg-cell>
              <clr-dg-cell>{{result.parentObject || '-'}}</clr-dg-cell>
            </clr-dg-row>

            <clr-dg-footer>
              <clr-dg-pagination #pagination [clrDgPageSize]="10">
                <clr-dg-page-size [clrPageSizeOptions]="[10, 20, 50]">每页显示</clr-dg-page-size>
                {{pagination.firstItem + 1}} - {{pagination.lastItem + 1}}
                共 {{pagination.totalItems}} 条
              </clr-dg-pagination>
            </clr-dg-footer>
          </clr-datagrid>
        </div>
      </div>
    </div>
  </div>
</div>

